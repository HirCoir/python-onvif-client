{% extends "base.html" %}

{% block content %}
<h2 class="text-2xl font-bold mb-4">Dashboard de Videos</h2>
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
    {% for video in videos %}
    <div class="bg-white shadow-md rounded-lg overflow-hidden relative video-item" data-path="{{ video.nombre }}">
        <div class="p-4">
            <h3 class="font-bold text-lg mb-2 truncate">{{ video.nombre }}</h3>
            {% if video.vista_previa %}
            <img src="data:image/jpeg;base64,{{ video.vista_previa }}" alt="Vista previa de {{ video.nombre }}" class="w-full h-32 object-cover mb-2 cursor-pointer" onclick="openVideoPopup('{{ url_for('serve_video', filename=video.nombre) }}')">
            {% else %}
            <div class="w-full h-32 bg-gray-200 flex items-center justify-center mb-2">
                <span class="text-gray-500">Vista previa no disponible</span>
            </div>
            {% endif %}
            <p class="text-gray-600 text-sm">Tamaño: {{ video.tamaño }} bytes</p>
            <p class="text-gray-600 text-sm">Modificado: {{ video.fecha_modificacion }}</p>
        </div>
    </div>
    {% endfor %}
</div>

<div class="mt-8 flex justify-center">
    {% if total_pages > 1 %}
        <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
            {% if page > 1 %}
                <a href="{{ url_for('index', page=page-1) }}" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                    <span class="sr-only">Previous</span>
                    <!-- Heroicon name: solid/chevron-left -->
                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                </a>
            {% endif %}
            
            {% for num in range(1, total_pages + 1) %}
                <a href="{{ url_for('index', page=num) }}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 {% if num == page %}bg-blue-50 text-blue-600{% endif %}">
                    {{ num }}
                </a>
            {% endfor %}
            
            {% if page < total_pages %}
                <a href="{{ url_for('index', page=page+1) }}" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                    <span class="sr-only">Next</span>
                    <!-- Heroicon name: solid/chevron-right -->
                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                    </svg>
                </a>
            {% endif %}
        </nav>
    {% endif %}
</div>

<div id="contextMenu" class="hidden fixed bg-white border border-gray-300 shadow-md rounded-md overflow-hidden z-50">
    <button onclick="showRenamePopup()" class="w-full text-left px-4 py-2 hover:bg-gray-100">Renombrar</button>
    <form id="deleteForm" action="{{ url_for('delete_video') }}" method="POST">
        <input type="hidden" name="video_path" id="deleteVideoPath">
        <button type="submit" class="w-full text-left px-4 py-2 hover:bg-gray-100 text-red-600">Eliminar</button>
    </form>
    <a id="downloadLink" href="#" class="block px-4 py-2 hover:bg-gray-100 text-green-600">Descargar</a>
</div>

<div id="renamePopup" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900">Renombrar video</h3>
            <div class="mt-2 px-7 py-3">
                <form id="renameForm" action="{{ url_for('rename_video') }}" method="POST">
                    <input type="hidden" name="old_path" id="oldVideoPath">
                    <input type="text" name="nuevo_nombre" id="newNameInput" placeholder="Nuevo nombre" class="w-full p-2 border rounded mb-3">
                    <button type="submit" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300">
                        Renombrar
                    </button>
                </form>
            </div>
            <div class="items-center px-4 py-3">
                <button id="closeRenamePopup" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-300">
                    Cancelar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentVideoPath = null;
let longPressTimer;
const longPressDuration = 500; // milliseconds

function showContextMenu(event, videoPath) {
    event.preventDefault();
    currentVideoPath = videoPath;
    const contextMenu = document.getElementById('contextMenu');
    contextMenu.style.display = 'block';
    
    // Position the menu near the touch point or mouse click
    const touchX = event.touches ? event.touches[0].clientX : event.clientX;
    const touchY = event.touches ? event.touches[0].clientY : event.clientY;
    
    contextMenu.style.left = `${touchX}px`;
    contextMenu.style.top = `${touchY}px`;

    document.getElementById('deleteVideoPath').value = videoPath;
    document.getElementById('downloadLink').href = `{{ url_for('download_video', filename='') }}${videoPath}`;

    document.addEventListener('click', hideContextMenu);
    document.addEventListener('touchstart', hideContextMenu);
}

function hideContextMenu() {
    document.getElementById('contextMenu').style.display = 'none';
    document.removeEventListener('click', hideContextMenu);
    document.removeEventListener('touchstart', hideContextMenu);
}

function showRenamePopup() {
    hideContextMenu();
    const popup = document.getElementById('renamePopup');
    popup.style.display = 'block';
    document.getElementById('oldVideoPath').value = currentVideoPath;
    document.getElementById('newNameInput').value = currentVideoPath.split('/').pop();
}

document.getElementById('closeRenamePopup').addEventListener('click', function() {
    document.getElementById('renamePopup').style.display = 'none';
});

document.querySelectorAll('.video-item').forEach(item => {
    item.addEventListener('contextmenu', function(e) {
        e.preventDefault();
        showContextMenu(e, this.dataset.path);
    });

    item.addEventListener('touchstart', function(e) {
        longPressTimer = setTimeout(() => {
            showContextMenu(e, this.dataset.path);
        }, longPressDuration);
    });

    item.addEventListener('touchend', function() {
        clearTimeout(longPressTimer);
    });

    item.addEventListener('touchmove', function() {
        clearTimeout(longPressTimer);
    });
});

document.getElementById('renameForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    fetch('{{ url_for('rename_video') }}', {
        method: 'POST',
        body: formData
    }).then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error al renombrar el video: ' + data.message);
        }
    }).catch(error => {
        console.error('Error:', error);
        alert('Ocurrió un error al renombrar el video');
    });
});

function openVideoPopup(videoSrc) {
    const popup = document.getElementById('videoPopup');
    const video = document.getElementById('popupVideo');
    video.src = videoSrc;
    popup.style.display = 'block';
    
    // Forzar la carga del video antes de intentar reproducirlo
    video.load();
    
    // Intentar reproducir el video después de un breve retraso
    setTimeout(() => {
        video.play().catch(error => {
            console.error('Error al reproducir el video:', error);
            // Si falla la reproducción automática, mostrar un mensaje al usuario
            alert('No se pudo reproducir el video automáticamente. Por favor, intente reproducirlo manualmente.');
        });
    }, 100);
}
</script>
{% endblock %}