{% extends "base.html" %}

{% block content %}
<h2 class="text-2xl font-bold mb-4">Grabación de Cámaras ONVIF</h2>

<div class="mb-8">
    <h3 class="text-xl font-bold mb-2">Agregar nueva cámara</h3>
    <form action="{{ url_for('add_camera') }}" method="POST" class="space-y-4">
        <div>
            <label for="camera_name" class="block text-sm font-medium text-gray-700">Nombre de la cámara:</label>
            <input type="text" id="camera_name" name="camera_name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
        </div>
        <div>
            <label for="camera_url" class="block text-sm font-medium text-gray-700">URL de la cámara (RTSP):</label>
            <input type="text" id="camera_url" name="camera_url" required placeholder="rtsp://admin:88888888@192.168.1.5:554/realmonitor?channel=0&stream=1.sdp" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
        </div>
        <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Agregar cámara</button>
    </form>
</div>

<div>
    <h3 class="text-xl font-bold mb-2">Cámaras configuradas</h3>
    {% for camera_name, camera in cameras.items() %}
    <div class="bg-white shadow-md rounded-lg p-4 mb-4">
        <h4 class="text-lg font-semibold mb-2">{{ camera_name }}</h4>
        <p class="mb-2">URL: {{ camera.url }}</p>
        <p class="mb-2">Estado: {% if camera.recording %}Grabando{% else %}Detenido{% endif %}</p>
        
        {% if camera.preview %}
        <img src="data:image/jpeg;base64,{{ camera.preview }}" alt="Vista previa de {{ camera_name }}" class="w-full h-32 object-cover mb-2">
        {% else %}
        <div class="w-full h-32 bg-gray-200 flex items-center justify-center mb-2">
            <span class="text-gray-500">Vista previa no disponible</span>
        </div>
        {% endif %}
        
        <form action="{{ url_for('update_camera') }}" method="POST" class="mb-4 space-y-2">
            <input type="hidden" name="camera_name" value="{{ camera_name }}">
            <div>
                <label for="new_name_{{ camera_name }}" class="block text-sm font-medium text-gray-700">Nuevo nombre:</label>
                <input type="text" id="new_name_{{ camera_name }}" name="new_name" value="{{ camera_name }}" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            </div>
            <div>
                <label for="camera_url_{{ camera_name }}" class="block text-sm font-medium text-gray-700">URL de la cámara:</label>
                <input type="text" id="camera_url_{{ camera_name }}" name="camera_url" value="{{ camera.url }}" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            </div>
            <div>
                <label for="loop_minutes_{{ camera_name }}" class="block text-sm font-medium text-gray-700">Minutos de grabación en loop:</label>
                <input type="number" id="loop_minutes_{{ camera_name }}" name="loop_minutes" value="{{ camera.loop_minutes }}" required min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            </div>
            <div>
                <label for="save_path_{{ camera_name }}" class="block text-sm font-medium text-gray-700">Ruta de guardado:</label>
                <input type="text" id="save_path_{{ camera_name }}" name="save_path" value="{{ camera.save_path }}" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            </div>
            <button type="submit" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">Actualizar configuración</button>
        </form>
        
        <div class="flex space-x-2">
            {% if not camera.recording %}
            <form action="{{ url_for('start_recording') }}" method="POST" class="inline">
                <input type="hidden" name="camera_name" value="{{ camera_name }}">
                <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Iniciar grabación</button>
            </form>
            {% else %}
            <form action="{{ url_for('stop_recording') }}" method="POST" class="inline">
                <input type="hidden" name="camera_name" value="{{ camera_name }}">
                <button type="submit" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">Detener grabación</button>
            </form>
            {% endif %}
            
            <form action="{{ url_for('delete_camera') }}" method="POST" class="inline" onsubmit="return confirm('¿Está seguro de que desea eliminar esta cámara?');">
                <input type="hidden" name="camera_name" value="{{ camera_name }}">
                <button type="submit" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">Eliminar cámara</button>
            </form>
        </div>
    </div>
    {% else %}
    <p>No hay cámaras configuradas.</p>
    {% endfor %}
</div>
{% endblock %}